<!DOCTYPE html>
<html>

  <script type="text/javascript" src="/assets/app.js"></script>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>How TCP-BBR Could Help Speed Up Internet</title>
    <meta name="description" content="I blog about projects I'm working on. Mostly about mobile games, tech, web service, little tiny things I built for myself or for public, and tech/game industry-wide. Currently I'm living in Shenzhen, China. I'm running a small creative company with my girlfriend here.
">

    <link rel="canonical" href="http://blog.wasin.io/blog/2017/05/08/how-tcp-bbr-could-help-speed-up-internet.html">
    <link rel="stylesheet" href="/css/vendor/weui.min.css">
    <link rel="stylesheet" href="/css/main.css">

    <link rel="stylesheet" type="text/css" href="
https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.css">

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/6.0.0/mermaid.min.js"></script>
	<script type="text/javascript">mermaid.initialize({startOnLoad:true});</script>
</head>


  <body>

    <header class="site-header">
  <div class="wrapper">
    <a class="site-title-white-bold" href=""/>Wasin</a><a class="site-title" href="/">'s Blog</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon" id="hamburgerBtn" onClick="if (window.getComputedStyle(this).getPropertyValue('display') != 'none') { showMainPagePicker('http://dashboard.wasin.io'); }">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="page-link" href="http://dashboard.wasin.io">Back to Dashboard</a>
        
      </div>
    </nav>
  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">How TCP-BBR Could Help Speed Up Internet</h1>
    <p class="post-meta">May 8, 2017</p>
  </header>

  <article class="post-content">
    <p>I&#39;ve come back to stay in Shenzhen, China since exactly 2 weeks ago.</p>

<p>Coming this time, Internet quality is pretty much worse than previous time in which I thought it was quite stable after fighting with GFW alot. Now the speed is quite low (lowest point can be &lt; <code>1 Mb/s</code>), and I cannot watch video online with good enough quality to enjoy the content. If it can be <code>144p</code> in smooth manner, that&#39;s what the best I could ask for.</p>

<p>It&#39;s like GFW really knows how to adapt. It learns from analyzing ton of packets flowing within China, and across the border. It learns to cut my SSR connection (prior to this it was still Ok). I need to find a reactive solution to fight back.</p>

<blockquote>
<p>I connected through my Shadowsocks server. Long before it was always SSR. Now I&#39;m fully using SS. It&#39;s better strategy to have alternatives or back ups plan for your connection available.</p>
</blockquote>

<h1>TCP-BBR</h1>

<hr>

<p>I came across to find this terminology by reading <a href="https://github.com/shadowsocks/shadowsocks-org/issues/26">discussion</a> on shadowsocks-org repository on Github. Especially <a href="https://github.com/shadowsocks/shadowsocks-org/issues/26#issuecomment-269444798">this</a>, and <a href="https://github.com/shadowsocks/shadowsocks-org/issues/26#issuecomment-269456260">this</a> comment that shows the result of speed testing using TCP-BBR which is a lot higher.</p>

<p>I&#39;m so hooked up with that. Thus I further did research on the topic on how to enable such feature on my proxy server.</p>

<p>Question found in <a href="https://github.com/shadowsocks/shadowsocks-org/issues/26#issuecomment-269487933">comment</a> that whether or not we need to enable it on both end of communication. Answer is no, so it&#39;s great as I&#39;m quite aware that macOS won&#39;t likely to support and really need to catch up in pace. Take example of <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=543653">Fast TCP Open</a> feature for Chrome on macOS. It still doesn&#39;t support!</p>

<h1>What Is It?</h1>

<hr>

<p>Refer to <a href="https://github.com/google/bbr/blob/master/Documentation/bbr-quick-start.md">google/bbr</a> and especially this <a href="http://git.kernel.org/cgit/linux/kernel/git/davem/net-next.git/commit/?id=0f8782ea14974ce992618b55f0c041ef43ed0b78">Linux Kernerl - TCP BBR commit</a>, if you want to dig deep right away for how it works, and algorithm in general.</p>

<p>In short and human word (in which by no mean I&#39;m an expert on network matter, and I don&#39;t like to act like one), TCP-BBR is another algorithm in TCP congestion control. It improves what has already been there via loss-based congestion control which is predominantly used since 1980s.</p>

<p>This new scheme is contributed by Google which commited back to Linux kernel for general public to use.</p>

<p>Refer to these notable excerpts I captured from its commit link.</p>

<p><img src="/assets/images/tcp-bbr/excerpt1.png" alt="excerpt tcp-bbr 1"></p>

<p><img src="/assets/images/tcp-bbr/excerpt1.png" alt="excerpt tcp-bbr 2"></p>

<p>The factor of improvement is magnificent. Although numbers stated above would be as high as ~2kx. From what I got as tested it&#39;s roughly <code>~600x</code> when pull content from upstream via Github clone command, or <code>~30x</code> in downstream Internet speed in general. It&#39;s way better than before.</p>

<h1>How to Enable It On Your Ubuntu 14.01 Server?</h1>

<hr>

<p>I learned the steps much from this <a href="https://github.com/iMeiji/shadowsocks_install/wiki/%E5%BC%80%E5%90%AFTCP-BBR%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95">guide</a> (in Chinese). So big shoutout to him. Allow me to replicate steps in English with slightly modified here.</p>

<p>I have Ubuntu <code>14.01</code> in which this kernel version doesn&#39;t support TCP-BBR just yet. You have to upgrade your kernel.<br>
Kernerl version <code>4.9+</code> is at least to support.</p>

<blockquote>
<p>For other Linux distros rather than Ubuntu, please follow this <a href="https://github.com/iMeiji/shadowsocks_install/wiki/%E5%BC%80%E5%90%AFTCP-BBR%E6%8B%A5%E5%A1%9E%E6%8E%A7%E5%88%B6%E7%AE%97%E6%B3%95">guide</a>.</p>
</blockquote>

<p>Follows the following steps</p>

<ul>
<li><p><strong>Download the lastest kernel</strong></p>

<p>You can also just head to <a href="http://kernel.ubuntu.com/%7Ekernel-ppa/mainline/">http://kernel.ubuntu.com/~kernel-ppa/mainline/</a> to select latest version by yourself in which case it might be newer after this article published. Download it to your system.  </p>

<p>Or just execute the following command,  </p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">wget http://kernel.ubuntu.com/~kernel-ppa/mainline/v4.10.9/linux-image-4.10.9-041009-generic_4.10.9-041009.201704080516_amd64.deb
</code></pre></div></li>
<li><p><strong>Install the kernel</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">dpkg -i linux-image-4.<span class="k">*</span>.deb
</code></pre></div></li>
<li><p><strong>Update grub system, then reboot</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">update-grub
reboot
</code></pre></div></li>
</ul>

<p>After your system has rebooted...</p>

<ul>
<li><p><strong>Check your kernel version</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">uname -r
</code></pre></div>
<p>You should get something like <code>4.10.X-XXXXXX-generic</code>. Make sure it starts with <code>4.9</code> or <code>4.10</code>, but if you follow all commands above it should be <code>4.10</code>.</p></li>
<li><p><strong>Edit <code>/etc/sysctl.conf</code> to have following lines</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">net.core.default_qdisc<span class="o">=</span>fq
net.ipv4.tcp_congestion_control<span class="o">=</span>bbr
</code></pre></div>
<p>This will instruct system to use <code>bbr</code> as congestion control for TCP.</p></li>
<li><p><strong>Save to make it effective</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">sysctl -p
</code></pre></div></li>
<li><p><strong>Check to confirm that settings are taken into effect</strong></p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">sysctl net.ipv4.tcp_available_congestion_control
sysctl net.ipv4.tcp_congestion_control
</code></pre></div>
<p>You should see output like <code>net.ipv4.tcp_available_congestion_control = bbr hybla cubic reno</code>, and
<code>net.ipv4.tcp_congestion_control = bbr</code>.</p>

<p>and lastly</p>
<div class="highlight"><pre><code class="language-shell" data-lang="shell">lsmod | grep bbr
</code></pre></div>
<p>you should see <code>tcp_bbr</code> there in output.</p></li>
</ul>

<h1>Result</h1>

<hr>

<p>Speed gained as tested over <a href="speedtest.net">speedtest.net</a>, or via tool like <a href="https://pypi.python.org/pypi/speedtest-cli/">speedtest-cli</a> might not be tremondous high. I gained speed like <code>10-30x</code> more, with lower ping (-<code>~20ms</code>).</p>

<p>But that increased speed plays a key role in consuming online content, in addition to performing Github commands i.e. cloning.</p>

<p>Result from my Github clone of big project in which normally I can clone it with average speed of around <code>~4KB/s</code> then sometimes it would stall then connection broken. It only can succeed for small to almost medium size project with good Internet time (not too much traffic). But now I do get the following</p>

<p><img src="/assets/images/tcp-bbr/tcp-bbr-more-speed.png" alt="github clone speed improved"></p>

<p>Average speed is good which is <code>2MB/s</code> and reliable.</p>

<p>It is not only Github, but also NPM which if you depend and use NodeJS-based packages, you will pull down lots of packages from it from time to time. Loads of files, and some certain package is very large in size. Thus they are much more better and reliable.</p>

<p>Finally, consuming video content online is much more pleasant without waiting for it to finishes buffering first. 360p quality in video is a norm, but if I need to go high like HD, I can do so too but slightly waiting in initial time might be required depends on traffic at that time. I also can watch live streaming without problem. Anyway, 360p quality is good enough for experience in my case of consuming educational, tutorial, songs kind of video.</p>

<p>In short, TCP-BBR helps significantly with minimal effort in upgrading your kernel to support it.<br>
As it&#39;s an addition to TCP protocol, it is compatible for all proxy applications you&#39;re using.</p>

<p>Give TCP-BBR a try. I strongly believe you will experience much better quality of Internet speed.</p>

  </article>

  
  	<span class="post-tags">Tags</span>:
  	bbr, network, tcp, tcp-bbr
	
</div>

      </div>
    </div>

    <a href="/feed.xml" class="weui-btn weui-btn_primary" style="border-radius: 0px">subscribe via RSS</a>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Wasin's Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Wasin's Blog</li>
          <li><a href="mailto:haxpor@gmail.com">haxpor@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/haxpor">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">haxpor</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/haxpor">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">haxpor</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://instagram.com/haxpor">
              <span class="icon  icon--instagram">
                <svg viewBox="0 0 512 512">
                  <g>
                    <path d="M256 109.3c47.8 0 53.4 0.2 72.3 1 17.4 0.8 26.9 3.7 33.2 6.2 8.4 3.2 14.3 7.1 20.6 13.4 6.3 6.3 10.1 12.2 13.4 20.6 2.5 6.3 5.4 15.8 6.2 33.2 0.9 18.9 1 24.5 1 72.3s-0.2 53.4-1 72.3c-0.8 17.4-3.7 26.9-6.2 33.2 -3.2 8.4-7.1 14.3-13.4 20.6 -6.3 6.3-12.2 10.1-20.6 13.4 -6.3 2.5-15.8 5.4-33.2 6.2 -18.9 0.9-24.5 1-72.3 1s-53.4-0.2-72.3-1c-17.4-0.8-26.9-3.7-33.2-6.2 -8.4-3.2-14.3-7.1-20.6-13.4 -6.3-6.3-10.1-12.2-13.4-20.6 -2.5-6.3-5.4-15.8-6.2-33.2 -0.9-18.9-1-24.5-1-72.3s0.2-53.4 1-72.3c0.8-17.4 3.7-26.9 6.2-33.2 3.2-8.4 7.1-14.3 13.4-20.6 6.3-6.3 12.2-10.1 20.6-13.4 6.3-2.5 15.8-5.4 33.2-6.2C202.6 109.5 208.2 109.3 256 109.3M256 77.1c-48.6 0-54.7 0.2-73.8 1.1 -19 0.9-32.1 3.9-43.4 8.3 -11.8 4.6-21.7 10.7-31.7 20.6 -9.9 9.9-16.1 19.9-20.6 31.7 -4.4 11.4-7.4 24.4-8.3 43.4 -0.9 19.1-1.1 25.2-1.1 73.8 0 48.6 0.2 54.7 1.1 73.8 0.9 19 3.9 32.1 8.3 43.4 4.6 11.8 10.7 21.7 20.6 31.7 9.9 9.9 19.9 16.1 31.7 20.6 11.4 4.4 24.4 7.4 43.4 8.3 19.1 0.9 25.2 1.1 73.8 1.1s54.7-0.2 73.8-1.1c19-0.9 32.1-3.9 43.4-8.3 11.8-4.6 21.7-10.7 31.7-20.6 9.9-9.9 16.1-19.9 20.6-31.7 4.4-11.4 7.4-24.4 8.3-43.4 0.9-19.1 1.1-25.2 1.1-73.8s-0.2-54.7-1.1-73.8c-0.9-19-3.9-32.1-8.3-43.4 -4.6-11.8-10.7-21.7-20.6-31.7 -9.9-9.9-19.9-16.1-31.7-20.6 -11.4-4.4-24.4-7.4-43.4-8.3C310.7 77.3 304.6 77.1 256 77.1L256 77.1z"/>
                    <path d="M256 164.1c-50.7 0-91.9 41.1-91.9 91.9s41.1 91.9 91.9 91.9 91.9-41.1 91.9-91.9S306.7 164.1 256 164.1zM256 315.6c-32.9 0-59.6-26.7-59.6-59.6s26.7-59.6 59.6-59.6 59.6 26.7 59.6 59.6S288.9 315.6 256 315.6z"/>
                    <circle cx="351.5" cy="160.5" r="21.5"/>
                  </g>
                </svg>
              </span>

              <span class="username">haxpor</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">I blog about projects I'm working on. Mostly about mobile games, tech, web service, little tiny things I built for myself or for public, and tech/game industry-wide. Currently I'm living in Shenzhen, China. I'm running a small creative company with my girlfriend here.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>
</html>
